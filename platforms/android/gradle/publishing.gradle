import groovy.json.JsonSlurper

apply plugin: "maven-publish"
apply plugin: "com.jfrog.artifactory"
apply plugin: "com.jfrog.bintray"

version = VERSION
group = GROUP

artifactoryPublish.mustRunAfter build

publishing {
    publications {
        nimbusPublication(MavenPublication) {
            artifact sourcesJar
//            if (project.plugins.hasPlugin("com.android.library")) {
//                artifact("$buildDir/outputs/aar/${project.name}-debug.aar")
//                artifact("$buildDir/outputs/aar/${project.name}-release.aar")
//            } else {
//                artifact("$buildDir/libs/${project.name}-${version}.jar")
//            }
            groupId group
            artifactId project.name
            version version
            pom {
                name.set(project.name)
                url.set(POM_URL)

                packaging POM_PACKAGING
                version version

                licenses {
                    license {
                        name.set(POM_LICENSE_NAME)
                        url.set(POM_LICENSE_URL)
                    }
                }

                developers {
                    developer {
                        name.set(POM_DEVELOPER)
                    }
                }

                scm {
                    url.set(POM_SCM_URL)
                    connection.set(POM_SCM_CONNECTION)
                    developerConnection.set(POM_SCM_DEV_CONNECTION)
                }
            }
        }
    }
}


bintray {
    def versionFile = file('../../../lerna.json')
    def parsedVersion = new JsonSlurper().parseText(versionFile.text)
    def versionToPublish = parsedVersion.version.toString()
    project.version = versionToPublish
    user = project.findProperty('bintrayUser') ?: System.getenv('BINTRAY_USER')
    key = project.findProperty('bintrayApiKey') ?: System.getenv('BINTRAY_API_KEY')
    configurations = ['archives']
    publish = true
    dryRun = true
    pkg {
        name = project.name
        repo = BINTRAY_REPO
        userOrg = BINTRAY_ORG
        licenses = [POM_LICENSE_NAME]
        vcsUrl = POM_SCM_URL
        labels = ['android', 'salesforce', 'hybrid']
        version {
            name = versionToPublish
            released = new Date()
        }
    }
}

artifactory {
    contextUrl = 'http://oss.jfrog.org'
    publish {
        repository {
            repoKey = 'oss-snapshot-local'
            username = project.findProperty('bintrayUser') ?: System.getenv('BINTRAY_USER')
            password = project.findProperty('bintrayApiKey') ?: System.getenv('BINTRAY_API_KEY')
            maven = true
        }
        defaults {
            publications('nimbusPublication')
            publishArtifacts = true
            publishPom = true
        }
    }
    resolve {
        repoKey = 'libs-snapshot'
        maven=true
    }
}
